@model List<YourProject.Models.PhieuMuon>

@{
    ViewData["Title"] = "Danh sách Phiếu Mượn";
}

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f7f7f7;
    }

    h2 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
    }

    table {
        width: 90%;
        margin: 0 auto;
        border-collapse: collapse;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        vertical-align: top;
    }

    th {
        background-color: #28a745;
        color: white;
    }

    tr:hover {
        background-color: #f1f1f1;
    }

    .message {
        text-align: center;
        margin-bottom: 15px;
        font-weight: bold;
    }

    .success {
        color: green;
    }

    .error {
        color: red;
    }

    .sach-list {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }

        .sach-list li {
            margin-bottom: 4px;
        }

    button {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        color: white;
    }

    .xem-btn {
        background-color: #007bff;
    }

        .xem-btn:hover {
            background-color: #0056b3;
        }

    .btn-danger {
        background-color: #dc3545;
    }

        .btn-danger:hover {
            background-color: #c82333;
        }
</style>

<h2>Danh sách Phiếu Mượn</h2>


@if (TempData["SuccessMessage"] != null)
{
    <div id="tempMessage" class="success" style="position: fixed; top: 20px; right: 20px;
             background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px;
             box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000;">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div id="tempMessage" class="error" style="position: fixed; top: 20px; right: 20px;
             background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;
             box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000;">
        @TempData["ErrorMessage"]
    </div>
}

<script>
    setTimeout(function () {
        var msg = document.getElementById('tempMessage');
        if (msg) { msg.style.display = 'none'; }
    }, 2500);
</script>

<table>
    <thead>
        <tr>
            <th>ID Phiếu</th>
            <th>Người Mượn</th>
            <th>Thủ Thư</th>
            <th>Sách Mượn</th>
            <th>Hành động</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any())
        {
            foreach (var pm in Model)
            {
                <tr>
                    <td>@pm.MaPhieuMuon</td>
                    <td>@pm.DocGia?.HoTen</td>
                    <td>@pm.ThuThu?.HoTen</td>
                    <td>
                        @if (pm.ChiTietPhieuMuons != null && pm.ChiTietPhieuMuons.Any())
                        {
                            <ul class="sach-list">
                                @foreach (var ct in pm.ChiTietPhieuMuons)
                                {
                                    <li>@ct.Sach?.TenSach</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <span>Không có sách</span>
                        }
                    </td>
                    <td>
                        <button type="button" class="xem-btn" onclick="xemChiTiet(@pm.MaPhieuMuon)">Xem</button>
                        <button class="btn-danger" onclick="deletePhieu(@pm.MaPhieuMuon)">Xóa</button>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="5" style="text-align:center;">Chưa có phiếu mượn nào</td>
            </tr>
        }
    </tbody>
</table>

<div id="hopChiTiet" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;">

    <div style="
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 500px;
        text-align: left;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    ">
        <h3 style="text-align:center;">Chi tiết phiếu mượn</h3>
        <div id="noiDungChiTiet">
           
        </div>
        <div style="text-align:center;">
            <button onclick="dongHopChiTiet()" style="margin-top: 10px; padding: 6px 12px;">Đóng</button>
        </div>
    </div>
</div>

<script>
    function xemChiTiet(maPhieuMuon) {
        fetch(`/PhieuMuon/ChiTiet/${maPhieuMuon}`)
            .then(response => {
                if (!response.ok) throw new Error("Không thể tải dữ liệu");
                return response.text();
            })
            .then(html => {
                document.getElementById("noiDungChiTiet").innerHTML = html;
                document.getElementById("hopChiTiet").style.display = "flex";
            })
            .catch(err => alert(err.message));
    }

    function dongHopChiTiet() {
        document.getElementById("hopChiTiet").style.display = "none";
    }

    function deletePhieu(maPhieuMuon) {
    if (confirm("Bạn có chắc muốn xóa phiếu mượn này không?")) {
        fetch(`/PhieuMuon/Delete/${maPhieuMuon}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                alert("Xóa phiếu mượn thành công!");
                location.reload();
            } else {
                alert("Lỗi khi xóa phiếu mượn!");
            }
        })
        .catch(error => console.error('Error:', error));
    }
    }
</script>

